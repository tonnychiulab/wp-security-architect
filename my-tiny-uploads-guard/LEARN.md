# LEARN.MD - My Tiny Uploads Guard 開發筆記

歡迎來到 **My Tiny Uploads Guard** 的幕後世界！這份文件不是枯燥的技術手冊，而是你的「數位嚮導」，帶你了解為什麼我們這樣設計這個外掛，以及駭客都在想什麼。

---

## 🧐 為什麼我們需要這個「小守衛」？

WordPress 的 `wp-content/uploads` 資料夾本來應該是個單純的地方，就像你家的相簿一樣，只應該放照片 (jpg, png)、影片 (mp4) 或文件 (pdf)。

但是，駭客非常喜歡把「後門」藏在這裡。

### 駭客的劇本通常是這樣的：
1.  找到一個有漏洞的外掛 (比如一個沒寫好的聯絡表單)。
2.  上傳一個偽裝成圖片的檔案 (例如 `avatar.php` 但改名為 `avatar.jpg.php` 甚至更隱密)。
3.  一旦這個檔案成功進入 `uploads` 資料夾，他們就可以隨時回來，像用遙控器一樣操控你的網站，發送垃圾郵件、跳轉廣告，甚至刪除你的資料。

**我們的任務**：抓出這些不速之客，而且要「快、狠、準」。

---

## 🏗️ 技術架構：為什麼我們要這樣寫？

在這個專案中，我們做出了一個關鍵的技術決定：**非同步分批掃描 (Async Chunking Scan)**。

### ❌ 傳統做法 (同步掃描) 的問題
如果你直接寫一個迴圈去掃描 uploads 資料夾：
```php
foreach ($files as $file) {
    scan($file); // 如果你有 10,000 張照片...
}
```
**結果**：你的網站會「卡死」甚至「炸掉」。
因為 PHP 程式執行通常有時間限制 (Time Limit，通常是 30 秒)。掃到一半被強制卡斷，使用者只會看到一個醜醜的錯誤畫面 (504 Gateway Timeout)，而且掃描還失敗了。

### ✅ 我們的做法 (非同步分批)
我們採用「螞蟻搬家」的策略：
1.  **使用者按鈕**：按下「開始掃描」。
2.  **前端 (JS)**：告訴後端「幫我掃 50 個檔案」。
3.  **後端 (PHP)**：乖乖掃完 50 個，然後回報：「我看完了，目前進度 5%，還沒發現問題。」
4.  **前端 (JS)**：收到回報，更新進度條，然後**自動**再發下一個請求：「好，再掃下 50 個」。

**好處**：
- **永不超時**：每次只跑短短幾秒，伺服器毫無壓力。
- **使用者體驗好**：你看得到進度條在跑，知道它在工作，而不是盯著一個轉圈圈的空白畫面發呆。

這就是 **Don't Break the Site (永不炸站)** 的最高原則。

---

## 🛡️ 我們如何抓壞人？(檢測邏輯)

我們採用 **「白名單 (Allowlist)」優先** 的策略。

與其去猜駭客會把檔案命名成什麼 (黑名單，永遠猜不完)，不如**只允許好人存在**。

- **規則 1：非我族類，其心必異**
  - 如果檔案副檔名不是圖檔 (jpg, png, gif, webp, svg...) 或常見文件 (pdf, doc, zip...)，**標記它！**
  - 特別是 `.php`, `.phtml`, `.php5` 這些執行檔，出現在 uploads 絕對是不正常的。

- **規則 2：隱藏的角落**
  - 正常的 WordPress 上傳只會用 `年份/月份` (例如 `2024/02`)分類。
  - 如果我們發現奇怪的目錄，例如 `.cache`, `tmp`, `~hidden`，裡面通常藏著不可告人的秘密。

---

## 🚀 接下來的計畫

現在我們已經把地基打好了 (外掛結構與主檔案)。接下來我們要蓋房子：

1.  **核心引擎**：寫出那個「螞蟻搬家」的掃描程式。
2.  **UI 介面**：做一個像樣的儀表板。
3.  **多國語系**：讓這個守衛能說各種語言。

準備好跟我一起寫程式了嗎？記得，安全是一場持續的遊戲，我們每一行程式碼都在保護某人的網站。
