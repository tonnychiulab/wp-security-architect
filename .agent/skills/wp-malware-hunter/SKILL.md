---
name: wp-malware-hunter
description: 2026 æ——è‰¦ç´š WordPress æƒ¡æ„è»Ÿé«”çµäººã€‚å°ˆç²¾æ–¼æª¢æ¸¬å¾Œé–€ã€webshellã€æœ¨é¦¬ã€‚çµåˆã€ŒéåŒæ­¥é˜²ç‚¸ç«™æ¶æ§‹ã€èˆ‡ã€Œä¸‰å±¤å¨è„…éæ¿¾æ¼æ–—ã€,é–‹ç™¼é«˜æ•ˆèƒ½ä¸”é«˜æº–ç¢ºç‡çš„é˜²è­·ç³»çµ±ã€‚
version: 2.0.0
---

# Role
ä½ æ˜¯ä¸€ä½ç²¾é€š PHP æ ¸å¿ƒèˆ‡è³‡è¨Šå®‰å…¨çš„è³‡æ·±æƒ¡æ„è»Ÿé«”çµäºº,å…¼å…· NinjaScanner çš„å·¥ç¨‹æ€ç¶­èˆ‡è³‡å®‰é‘‘è­˜å°ˆå®¶çš„çµæ®ºç›´è¦ºã€‚ä½ çš„ä½¿å‘½æ˜¯æ‰¾å‡ºéš±è—åœ¨ WordPress ç¶²ç«™ä¸­çš„æƒ¡æ„ä»£ç¢¼,è€Œä¸æ˜¯é–‹ç™¼äººå“¡çš„å¤±èª¤ã€‚

# When to Use This Skill

## è§¸ç™¼æ¢ä»¶

è§¸ç™¼æ­¤æŠ€èƒ½ç•¶ç”¨æˆ¶:
- è¦æ±‚æƒæã€Œæƒ¡æ„è»Ÿé«”ã€ã€ã€Œå¾Œé–€ã€ã€ã€Œæœ¨é¦¬ã€ã€ã€Œwebshellã€ã€ã€Œç—…æ¯’ã€
- ç¶²ç«™è¢«å…¥ä¾µæˆ–æ‡·ç–‘è¢«æ¤å…¥æƒ¡æ„ä»£ç¢¼
- è©¢å•ã€Œæˆ‘çš„ç¶²ç«™å®‰å…¨å—?ã€ã€ã€Œæª¢æŸ¥æ˜¯å¦æœ‰å¾Œé–€ã€ã€ã€Œç¶²ç«™æ˜¯å¦è¢«é»‘ã€
- ä¸Šå‚³å¯ç–‘æ–‡ä»¶ä¸¦è¦æ±‚åˆ†æå…¶æ˜¯å¦ç‚ºæƒ¡æ„ä»£ç¢¼
- è«‹æ±‚é–‹ç™¼æˆ–æ”¹é€²æƒ¡æ„è»Ÿé«”æƒæå™¨ã€é˜²è­·æ’ä»¶
- ä½¿ç”¨é—œéµè©: malware scan, backdoor detection, webshell, virus check, hack check, infected site, security scanner
- è¦æ±‚å¯¦ç¾é¡ä¼¼ Wordfenceã€Sucuriã€MalCareã€NinjaScanner çš„åŠŸèƒ½
- è«‹æ±‚åˆ†æç¶²ç«™å…¥ä¾µåŸå› æˆ–æ¸…ç†è¢«é»‘ç¶²ç«™

## èˆ‡å…¶ä»– Skills çš„å€åˆ¥

**wp-malware-hunter vs wp-code-auditor**:
- **malware-hunter**: å°‹æ‰¾ã€Œæƒ¡æ„æ¤å…¥ã€çš„å¾Œé–€ä»£ç¢¼å’Œå·²å­˜åœ¨çš„å¨è„…
  - ç›®æ¨™: è¢«é»‘å®¢åˆ»æ„æ”¾ç½®çš„æƒ¡æ„æ–‡ä»¶
  - æ–¹æ³•: ç‰¹å¾µç¢¼ã€è¡Œç‚ºåˆ†æã€ç•°å¸¸æª¢æ¸¬
  - ç¯„ä¾‹: `eval(base64_decode(...))`, webshell, C&C é€£æ¥

- **code-auditor**: å°‹æ‰¾ã€Œé–‹ç™¼éŒ¯èª¤ã€å°è‡´çš„å®‰å…¨æ¼æ´
  - ç›®æ¨™: é–‹ç™¼è€…çš„ç·¨ç¢¼ç–å¤±
  - æ–¹æ³•: éœæ…‹ä»£ç¢¼åˆ†æã€OWASP è¦å‰‡æª¢æŸ¥
  - ç¯„ä¾‹: SQL Injection, XSS, CSRF

**ç°¡å–®åˆ¤æ–·**:
- å¦‚æœå•é¡Œæ˜¯ã€Œä»£ç¢¼å¯«å¾—ä¸å®‰å…¨ã€â†’ code-auditor
- å¦‚æœå•é¡Œæ˜¯ã€Œæœ‰äººæ”¾äº†å£æ±è¥¿é€²ä¾†ã€â†’ malware-hunter

---

# Core Philosophy (æ ¸å¿ƒé–‹ç™¼å“²å­¸)

## 1. Don't Break the Site (æ°¸ä¸ç‚¸ç«™)
æƒæéç¨‹å¿…é ˆåˆ†æ‰¹åŸ·è¡Œ (Chunking),åš´ç¦åœ¨å–®æ¬¡ Request ä¸­æƒæå…¨ç«™ã€‚

**ç‚ºä»€éº¼?**
- å¤§å‹ç¶²ç«™å¯èƒ½æœ‰ 10,000+ æ–‡ä»¶
- PHP `max_execution_time` é€šå¸¸åªæœ‰ 30-60 ç§’
- ä¸€æ¬¡æ€§æƒææœƒå°è‡´:
  - è¶…æ™‚ (504 Gateway Timeout)
  - è¨˜æ†¶é«”è€—ç›¡ (Fatal Error)
  - ä¼ºæœå™¨è² è¼‰éé«˜
  - ç”¨æˆ¶ç„¡æ³•è¨ªå•ç¶²ç«™

**è§£æ±ºæ–¹æ¡ˆ**:
- ä½¿ç”¨ AJAX è¼ªè©¢æˆ– WordPress Action Scheduler
- æ¯æ‰¹æ¬¡è™•ç† 50-100 å€‹æ–‡ä»¶
- åš´æ ¼é™åˆ¶æ¯æ‰¹æ¬¡åŸ·è¡Œæ™‚é–“ (2-3 ç§’)
- ä¿å­˜é€²åº¦,æ”¯æŒä¸­æ–·æ¢å¾©

## 2. Defense in Depth (ç¸±æ·±é˜²ç¦¦)
æ¡ç”¨ã€Œç†µå€¼ â†’ ç‰¹å¾µ â†’ è¡Œç‚ºã€çš„ä¸‰å±¤éæ¿¾æ¼æ–—,ä¸ä¾è³´å–®ä¸€åˆ¤æ–·æ¨™æº–ã€‚

**ç‚ºä»€éº¼?**
- å–®ä¸€æª¢æ¸¬æ–¹æ³•å®¹æ˜“è¢«ç¹é
- æƒ¡æ„ä»£ç¢¼ä¸æ–·é€²åŒ–,æ··æ·†æŠ€è¡“æ—¥æ–°æœˆç•°
- éœ€è¦å¹³è¡¡ã€Œæª¢å‡ºç‡ã€èˆ‡ã€Œèª¤å ±ç‡ã€

**ç­–ç•¥**:
- Layer 1: å¿«é€Ÿæ’é™¤å·²çŸ¥å®‰å…¨çš„æ–‡ä»¶ (ç™½åå–® + ç†µå€¼)
- Layer 2: ç‰¹å¾µç¢¼ç²¾ç¢ºåŒ¹é…å·²çŸ¥æƒ¡æ„æ¨¡å¼
- Layer 3: å•Ÿç™¼å¼åˆ†ææœªçŸ¥å¨è„…

## 3. Fail-Safe (æ•…éšœå®‰å…¨)
é‡åˆ°ç„¡æ³•è®€å–çš„æª”æ¡ˆæˆ–æ¬Šé™éŒ¯èª¤,æ‡‰è¨˜éŒ„ä¸¦è·³é,è€Œéè®“æ•´å€‹ Process å´©æ½°ã€‚

**ç‚ºä»€éº¼?**
- æ–‡ä»¶æ¬Šé™å•é¡Œæ˜¯å¸¸æ…‹ (å°¤å…¶ shared hosting)
- æå£çš„æ–‡ä»¶ã€ç¬¦è™Ÿé€£çµã€ç‰¹æ®Šå­—ç¬¦æ–‡ä»¶å
- æƒæå™¨çš„å¯ç”¨æ€§æ¯”å®Œç¾æ€§æ›´é‡è¦

**å¯¦è¸**:
- ä½¿ç”¨ `@` æŠ‘åˆ¶éŒ¯èª¤ä½†è¨˜éŒ„æ—¥èªŒ
- Try-catch åŒ…è£¹é—œéµæ“ä½œ
- æä¾›ã€Œè·³éçš„æ–‡ä»¶æ¸…å–®ã€çµ¦ç®¡ç†å“¡

---

# Technical Capabilities (æŠ€è¡“èƒ½åŠ›æŒ‡å°)

## 1. æ ¸å¿ƒå¼•æ“æ¶æ§‹ (The Engine)

### éåŒæ­¥åˆ†æ‰¹æƒæç³»çµ±

ç•¶é–‹ç™¼æƒæå™¨æœ¬é«”æ™‚,**å¿…é ˆ** éµå®ˆä»¥ä¸‹è¦ç¯„:

**å¢é‡è™•ç†æ¶æ§‹**:
```php
class WPSA_Async_Scanner {
    
    const BATCH_SIZE = 50;        // æ¯æ‰¹æ¬¡æ–‡ä»¶æ•¸
    const TIME_LIMIT = 3;         // æ¯æ‰¹æ¬¡æœ€é•·åŸ·è¡Œæ™‚é–“ (ç§’)
    const MEMORY_THRESHOLD = 80;  // è¨˜æ†¶é«”ä½¿ç”¨é–¾å€¼ (%)
    
    /**
     * åˆå§‹åŒ–æƒæ
     */
    public function start_scan() {
        // 1. é‡ç½®æƒæç‹€æ…‹
        $this->reset_scan_state();
        
        // 2. å»ºç«‹æ–‡ä»¶ç´¢å¼•
        $this->build_file_index();
        
        // 3. è§¸ç™¼ç¬¬ä¸€æ‰¹æƒæ
        wp_schedule_single_event( time(), 'wpsa_scan_batch' );
    }
    
    /**
     * æƒæä¸€å€‹æ‰¹æ¬¡
     */
    public function scan_batch() {
        $start_time = microtime( true );
        $progress = $this->get_scan_progress();
        
        // ç²å–å¾…æƒææ–‡ä»¶
        $files = $this->get_pending_files( 
            $progress['offset'], 
            self::BATCH_SIZE 
        );
        
        foreach ( $files as $file ) {
            // 1. æ™‚é–“ä¿è­· - å¼·åˆ¶ä¸­æ–·æ©Ÿåˆ¶
            if ( $this->should_stop_batch( $start_time ) ) {
                $this->save_progress_and_continue( $progress );
                return;
            }
            
            // 2. è¨˜æ†¶é«”ä¿è­·
            if ( $this->is_memory_critical() ) {
                gc_collect_cycles();
                
                if ( $this->is_memory_critical() ) {
                    $this->save_progress_and_continue( $progress );
                    return;
                }
            }
            
            // 3. åŸ·è¡Œä¸‰å±¤æª¢æ¸¬
            $this->scan_single_file( $file, $progress );
            
            // 4. æ›´æ–°é€²åº¦
            $progress['offset']++;
            $progress['scanned']++;
        }
        
        // æª¢æŸ¥æ˜¯å¦å®Œæˆ
        if ( $progress['scanned'] >= $progress['total'] ) {
            $this->finalize_scan( $progress );
        } else {
            $this->save_progress_and_continue( $progress );
        }
    }
    
    /**
     * åˆ¤æ–·æ˜¯å¦æ‡‰è©²åœæ­¢ç•¶å‰æ‰¹æ¬¡
     */
    private function should_stop_batch( $start_time ) {
        $elapsed = microtime( true ) - $start_time;
        return $elapsed > self::TIME_LIMIT;
    }
    
    /**
     * æª¢æŸ¥è¨˜æ†¶é«”æ˜¯å¦é”åˆ°è‡¨ç•Œå€¼
     */
    private function is_memory_critical() {
        $limit = ini_get( 'memory_limit' );
        $limit_bytes = $this->convert_to_bytes( $limit );
        $current = memory_get_usage( true );
        
        $percentage = ( $current / $limit_bytes ) * 100;
        
        return $percentage > self::MEMORY_THRESHOLD;
    }
}
```

**Action Scheduler æ•´åˆ**:
```php
// è¨»å†Š hook
add_action( 'wpsa_scan_batch', array( $scanner, 'scan_batch' ) );

// æ’ç¨‹ä¸‹ä¸€æ‰¹æ¬¡ (åœ¨ç•¶å‰æ‰¹æ¬¡çµæŸæ™‚)
function save_progress_and_continue( $progress ) {
    update_option( 'wpsa_scan_progress', $progress );
    
    // ç«‹å³æ’ç¨‹ä¸‹ä¸€æ‰¹ (éåŒæ­¥åŸ·è¡Œ)
    wp_schedule_single_event( time(), 'wpsa_scan_batch' );
}
```

**å‰ç«¯é€²åº¦é¡¯ç¤º**:
```javascript
// AJAX è¼ªè©¢é€²åº¦
function checkScanProgress() {
    jQuery.ajax({
        url: ajaxurl,
        data: { action: 'wpsa_get_progress' },
        success: function(response) {
            var percent = (response.scanned / response.total) * 100;
            jQuery('#progress-bar').css('width', percent + '%');
            jQuery('#progress-text').text(response.scanned + ' / ' + response.total);
            
            if (response.status === 'running') {
                setTimeout(checkScanProgress, 1000);
            } else if (response.status === 'completed') {
                showResults(response.threats);
            }
        }
    });
}
```

---

## 2. ä¸‰å±¤æª¢æ¸¬å”å®š (The Detection Protocol)

åœ¨æƒææ¯ä¸€å€‹æª”æ¡ˆæ™‚,ä¾ç…§é‹ç®—æˆæœ¬ç”±ä½åˆ°é«˜åŸ·è¡Œæª¢æŸ¥ã€‚æ—©æœŸæª¢æ¸¬åˆ°å¨è„…æˆ–ç¢ºèªå®‰å…¨å¾Œ,ç«‹å³è·³å‡º,é¿å…ä¸å¿…è¦çš„é‹ç®—ã€‚

### Layer 1: å¿«é€Ÿç¯©é¸ (Fast Pass)

**ç›®æ¨™**: åœ¨ 0.001 ç§’å…§åˆ¤æ–·æ–‡ä»¶æ˜¯å¦ç‚ºå·²çŸ¥å®‰å…¨æˆ–é«˜åº¦å¯ç–‘

#### 1.1 Checksum ç™½åå–®é©—è­‰

**åŸç†**: 
WordPress å®˜æ–¹ç‚ºæ¯å€‹ç‰ˆæœ¬çš„æ ¸å¿ƒæ–‡ä»¶æä¾› MD5 checksumsã€‚å¦‚æœæ–‡ä»¶çš„ hash å€¼èˆ‡å®˜æ–¹ä¸€è‡´,å¯ä»¥ç›´æ¥è·³éã€‚

**å¯¦ç¾**:
```php
class WPSA_Checksum_Validator {
    
    private $core_checksums = null;
    
    /**
     * é©—è­‰æ ¸å¿ƒæ–‡ä»¶å®Œæ•´æ€§
     */
    public function verify_core_file( $file_path ) {
        // 1. ç¢ºå®š WordPress ç‰ˆæœ¬
        global $wp_version;
        
        // 2. ç²å–å®˜æ–¹ checksums (å¸¶ç·©å­˜)
        if ( $this->core_checksums === null ) {
            $this->core_checksums = $this->get_core_checksums( $wp_version );
        }
        
        // 3. è¨ˆç®—ç›¸å°è·¯å¾‘
        $relative_path = $this->get_relative_path( $file_path );
        
        // 4. æª¢æŸ¥æ˜¯å¦ç‚ºæ ¸å¿ƒæ–‡ä»¶
        if ( ! isset( $this->core_checksums[ $relative_path ] ) ) {
            return null; // ä¸æ˜¯æ ¸å¿ƒæ–‡ä»¶,ç„¡æ³•é©—è­‰
        }
        
        // 5. æ¯”å° MD5
        $expected_md5 = $this->core_checksums[ $relative_path ];
        $actual_md5 = md5_file( $file_path );
        
        if ( $actual_md5 === $expected_md5 ) {
            return 'VERIFIED_SAFE'; // é€šéé©—è­‰,å®‰å…¨
        } else {
            return 'MODIFIED_CORE'; // æ ¸å¿ƒæ–‡ä»¶è¢«ä¿®æ”¹!
        }
    }
    
    /**
     * å¾ WordPress.org API ç²å– checksums
     */
    private function get_core_checksums( $version ) {
        $transient_key = 'wpsa_checksums_' . $version;
        $checksums = get_transient( $transient_key );
        
        if ( false === $checksums ) {
            $url = "https://api.wordpress.org/core/checksums/1.0/?version=$version";
            $response = wp_remote_get( $url );
            
            if ( is_wp_error( $response ) ) {
                return array();
            }
            
            $body = json_decode( wp_remote_retrieve_body( $response ), true );
            $checksums = $body['checksums'] ?? array();
            
            // ç·©å­˜ 24 å°æ™‚
            set_transient( $transient_key, $checksums, DAY_IN_SECONDS );
        }
        
        return $checksums;
    }
    
    /**
     * ç²å–ç›¸å°æ–¼ ABSPATH çš„è·¯å¾‘
     */
    private function get_relative_path( $file_path ) {
        $relative = str_replace( ABSPATH, '', $file_path );
        return str_replace( '\\', '/', $relative ); // Windows è·¯å¾‘
    }
}
```

**é©ç”¨ç¯„åœ**:
- âœ… WordPress æ ¸å¿ƒæ–‡ä»¶ (`wp-admin/`, `wp-includes/`, æ ¹ç›®éŒ„çš„ `.php`)
- âŒ æ’ä»¶å’Œä¸»é¡Œ (éœ€è¦é¡å¤–çš„ API æˆ–æœ¬åœ°æ•¸æ“šåº«)
- âŒ ç¬¬ä¸‰æ–¹è³¼è²·çš„é«˜ç´šæ’ä»¶/ä¸»é¡Œ

**æª¢æ¸¬çµæœ**:
- `VERIFIED_SAFE`: æ–‡ä»¶å®Œå…¨ä¸€è‡´,ç›´æ¥è·³éå¾ŒçºŒæª¢æ¸¬
- `MODIFIED_CORE`: **Critical** è­¦å ±,æ ¸å¿ƒæ–‡ä»¶è¢«ä¿®æ”¹
- `null`: éæ ¸å¿ƒæ–‡ä»¶,ç¹¼çºŒå¾ŒçºŒæª¢æ¸¬

#### 1.2 Shannon Entropy (ç†µå€¼) è¨ˆç®—

**åŸç†**:
Shannon Entropy æ¸¬é‡å­—ä¸²çš„éš¨æ©Ÿæ€§/æ··äº‚åº¦ã€‚æƒ¡æ„ä»£ç¢¼é€šå¸¸æœƒä½¿ç”¨ Base64 æˆ–å…¶ä»–ç·¨ç¢¼ä¾†æ··æ·†,å°è‡´ç†µå€¼ç•°å¸¸é«˜ã€‚

**æ•¸å­¸å…¬å¼**:
```
H(X) = -Î£ P(xi) * log2(P(xi))

å…¶ä¸­:
- P(xi) = å­—ç¬¦ xi å‡ºç¾çš„æ¦‚ç‡
- H(X) = ç†µå€¼ (0-8 ä¹‹é–“,8 ç‚ºæœ€é«˜)
```

**å¯¦ç¾**:
```php
class WPSA_Entropy_Analyzer {
    
    const THRESHOLD = 5.5; // é–¾å€¼
    
    /**
     * è¨ˆç®— Shannon Entropy
     */
    public function calculate_entropy( $string ) {
        $entropy = 0;
        $size = strlen( $string );
        
        if ( $size === 0 ) {
            return 0;
        }
        
        // çµ±è¨ˆæ¯å€‹å­—ç¬¦å‡ºç¾çš„æ¬¡æ•¸
        $frequency = array_count_values( str_split( $string ) );
        
        foreach ( $frequency as $char => $count ) {
            $probability = $count / $size;
            $entropy -= $probability * log( $probability, 2 );
        }
        
        return $entropy;
    }
    
    /**
     * æª¢æŸ¥æ–‡ä»¶çš„ç†µå€¼
     */
    public function check_file_entropy( $file_path ) {
        // è®€å–æ–‡ä»¶å…§å®¹
        $content = @file_get_contents( $file_path );
        
        if ( $content === false ) {
            return null; // ç„¡æ³•è®€å–
        }
        
        // è¨ˆç®—ç†µå€¼
        $entropy = $this->calculate_entropy( $content );
        
        // æª¢æŸ¥æ˜¯å¦è¶…éé–¾å€¼
        if ( $entropy > self::THRESHOLD ) {
            // æ’é™¤èª¤å ±
            if ( $this->is_false_positive( $file_path, $content ) ) {
                return 'SAFE';
            }
            
            return array(
                'threat' => 'HIGH_ENTROPY',
                'entropy' => $entropy,
                'severity' => 'MEDIUM',
            );
        }
        
        return 'SAFE';
    }
    
    /**
     * æ’é™¤å·²çŸ¥çš„é«˜ç†µä½†åˆæ³•çš„æ–‡ä»¶
     */
    private function is_false_positive( $file_path, $content ) {
        // 1. æ–‡ä»¶é¡å‹ç™½åå–®
        $safe_extensions = array( 'jpg', 'jpeg', 'png', 'gif', 'ttf', 'woff', 'woff2' );
        $extension = pathinfo( $file_path, PATHINFO_EXTENSION );
        
        if ( in_array( strtolower( $extension ), $safe_extensions ) ) {
            return true;
        }
        
        // 2. Minified JS/CSS
        if ( preg_match('/\.(min\.js|min\.css)$/i', $file_path ) ) {
            return true;
        }
        
        // 3. node_modules æˆ– vendor ç›®éŒ„
        if ( strpos( $file_path, 'node_modules' ) !== false || 
             strpos( $file_path, 'vendor' ) !== false ) {
            return true;
        }
        
        // 4. Data URI (Base64 åœ–ç‰‡å…§åµŒ)
        if ( preg_match('/data:image\/[^;]+;base64,/i', $content ) ) {
            return true;
        }
        
        return false;
    }
}
```

**ç†µå€¼åƒè€ƒæ¨™æº–**:
| é¡å‹ | ç†µå€¼ç¯„åœ | ç¯„ä¾‹ |
|------|---------|------|
| æ­£å¸¸ PHP ä»£ç¢¼ | 3.5 - 4.5 | `<?php echo "Hello"; ?>` |
| è‹±æ–‡æ–‡æœ¬ | 4.0 - 4.5 | æ™®é€šæ–‡ç«  |
| Base64 ç·¨ç¢¼ | 6.0 - 6.5 | `YWJjZGVmZ2hpamtsbW5vcA==` |
| åŠ å¯†/æ··æ·†ä»£ç¢¼ | 7.0 - 8.0 | `\x4a\x8b\x3f\x9e...` |
| **é–¾å€¼è¨­å®š** | **5.5** | å¹³è¡¡æª¢å‡ºç‡èˆ‡èª¤å ±ç‡ |

**æª¢æ¸¬çµæœ**:
- `SAFE`: ç†µå€¼æ­£å¸¸æˆ–ç‚ºèª¤å ±
- `HIGH_ENTROPY`: é«˜ç†µå€¼,æ¨™è¨˜ç‚ºå¯ç–‘

---

### Layer 2: ç‰¹å¾µç¢¼æ¯”å° (Signature Matching)

**ç›®æ¨™**: ç²¾ç¢ºåŒ¹é…å·²çŸ¥çš„æƒ¡æ„ä»£ç¢¼æ¨¡å¼

#### 2.1 å±éšªå‡½æ•¸çµ„åˆæª¢æ¸¬

**åŸç†**: 
å–®ä¸€å‡½æ•¸ (å¦‚ `eval`) ä¸ä¸€å®šæ˜¯æƒ¡æ„çš„,ä½†ç•¶èˆ‡ `base64_decode` çµ„åˆä½¿ç”¨æ™‚,å¹¾ä¹è‚¯å®šæ˜¯å¾Œé–€ã€‚

**é«˜é¢¨éšªçµ„åˆæ¨¡å¼**:
```php
class WPSA_Signature_Scanner {
    
    /**
     * å±éšªå‡½æ•¸çµ„åˆç‰¹å¾µåº«
     */
    private function get_malware_signatures() {
        return array(
            // 1. Eval + Base64 (æœ€ç¶“å…¸çš„å¾Œé–€)
            array(
                'name' => 'eval_base64',
                'pattern' => '/eval\s*\(\s*base64_decode/i',
                'severity' => 'CRITICAL',
                'description' => 'Eval with Base64 decode - Classic backdoor pattern',
                'example' => 'eval(base64_decode("ZXZhbCgkX1BPU1RbJ2NtZCddKTs="));',
            ),
            
            // 2. Assert + Base64 (PHP 7 ä¹‹å¾Œå¸¸ç”¨çš„æ›¿ä»£)
            array(
                'name' => 'assert_base64',
                'pattern' => '/assert\s*\(\s*base64_decode/i',
                'severity' => 'CRITICAL',
                'description' => 'Assert with Base64 - Alternative to eval()',
            ),
            
            // 3. Create Function (å‹•æ…‹å‡½æ•¸å‰µå»º)
            array(
                'name' => 'create_function_base64',
                'pattern' => '/create_function\s*\(.*base64_decode/is',
                'severity' => 'HIGH',
                'description' => 'Dynamic function creation with encoded payload',
            ),
            
            // 4. Preg Replace /e modifier (PHP < 7.0 çš„ RCE)
            array(
                'name' => 'preg_replace_e',
                'pattern' => '/preg_replace\s*\(\s*[\'"][^\'\"]*\/e[\'\"]/i',
                'severity' => 'HIGH',
                'description' => 'Preg_replace with /e modifier - Code execution',
                'note' => 'Deprecated in PHP 5.5, removed in PHP 7.0',
            ),
            
            // 5. ç³»çµ±å‘½ä»¤åŸ·è¡Œ + ç”¨æˆ¶è¼¸å…¥
            array(
                'name' => 'system_user_input',
                'pattern' => '/(system|exec|shell_exec|passthru|popen|proc_open)\s*\(\s*\$_(GET|POST|REQUEST|COOKIE)/i',
                'severity' => 'CRITICAL',
                'description' => 'Direct OS command execution from user input',
            ),
            
            // 6. File Get Contents + External URL (C&C é€£æ¥)
            array(
                'name' => 'remote_file_inclusion',
                'pattern' => '/file_get_contents\s*\(\s*[\'"]https?:\/\//i',
                'severity' => 'HIGH',
                'description' => 'Remote file inclusion - Potential C&C communication',
            ),
            
            // 7. Gzinflate + Base64 (å£“ç¸®æ··æ·†)
            array(
                'name' => 'gzinflate_base64',
                'pattern' => '/gzinflate\s*\(\s*base64_decode/i',
                'severity' => 'HIGH',
                'description' => 'Gzinflate with Base64 - Compressed obfuscation',
            ),
            
            // 8. Str_rot13 + Base64 (é›™é‡ç·¨ç¢¼)
            array(
                'name' => 'str_rot13_base64',
                'pattern' => '/str_rot13\s*\(\s*base64_decode/i',
                'severity' => 'HIGH',
                'description' => 'ROT13 with Base64 - Double encoding obfuscation',
            ),
            
            // 9. PHP Webshell å¸¸è¦‹æŒ‡ç´‹
            array(
                'name' => 'webshell_fingerprint',
                'pattern' => '/(\$_FILES.*move_uploaded_file|\$_GET.*passthru|c99shell|r57shell|wso\.php)/i',
                'severity' => 'CRITICAL',
                'description' => 'Known webshell fingerprint detected',
            ),
        );
    }
    
    /**
     * æƒææ–‡ä»¶ä¸­çš„æƒ¡æ„ç‰¹å¾µ
     */
    public function scan_file_signatures( $content ) {
        $threats = array();
        $signatures = $this->get_malware_signatures();
        
        foreach ( $signatures as $sig ) {
            if ( preg_match( $sig['pattern'], $content, $matches ) ) {
                $threats[] = array(
                    'type' => 'MALWARE_SIGNATURE',
                    'signature_name' => $sig['name'],
                    'severity' => $sig['severity'],
                    'description' => $sig['description'],
                    'matched_code' => $this->extract_context( $content, $matches[0] ),
                );
            }
        }
        
        return $threats;
    }
    
    /**
     * æå–åŒ¹é…ä»£ç¢¼çš„ä¸Šä¸‹æ–‡ (å‰å¾Œå„ 2 è¡Œ)
     */
    private function extract_context( $content, $matched_string ) {
        $lines = explode( "\n", $content );
        $match_line = 0;
        
        // æ‰¾åˆ°åŒ¹é…çš„è¡Œè™Ÿ
        foreach ( $lines as $index => $line ) {
            if ( strpos( $line, $matched_string ) !== false ) {
                $match_line = $index;
                break;
            }
        }
        
        // æå–ä¸Šä¸‹æ–‡ (å‰å¾Œå„ 2 è¡Œ)
        $start = max( 0, $match_line - 2 );
        $end = min( count( $lines ) - 1, $match_line + 2 );
        
        $context_lines = array_slice( $lines, $start, $end - $start + 1 );
        
        return array(
            'line_number' => $match_line + 1,
            'code' => implode( "\n", $context_lines ),
        );
    }
}
```

#### 2.2 æ··æ·†æŠ€è¡“åµæ¸¬

**å¸¸è¦‹æ··æ·†æ‰‹æ³•**:
```php
class WPSA_Obfuscation_Detector {
    
    /**
     * æª¢æ¸¬æ··æ·†æŠ€è¡“
     */
    public function detect_obfuscation( $content ) {
        $indicators = array();
        
        // 1. å­—ä¸²åè½‰ (strrev)
        if ( preg_match('/strrev\s*\(\s*[\'"][^\'"]+[\'"]\s*\)/i', $content, $matches ) ) {
            $reversed_string = $matches[0];
            
            // æª¢æŸ¥åè½‰å¾Œæ˜¯å¦ç‚ºå±éšªå‡½æ•¸å
            if ( preg_match('/strrev\s*\(\s*[\'"]([^\'"]+)[\'"]\s*\)/i', $reversed_string, $inner ) ) {
                $original = strrev( $inner[1] );
                $dangerous = array( 'eval', 'assert', 'system', 'exec', 'base64_decode' );
                
                if ( in_array( $original, $dangerous ) ) {
                    $indicators['string_reversal'] = array(
                        'severity' => 'HIGH',
                        'description' => "Reversed function name: $original",
                    );
                }
            }
        }
        
        // 2. éåº¦å­—ä¸²æ‹¼æ¥ (è¶…é 10 æ¬¡)
        $concat_count = preg_match_all('/\'\s*\.\s*\'/i', $content );
        if ( $concat_count > 10 ) {
            $indicators['excessive_concatenation'] = array(
                'severity' => 'MEDIUM',
                'description' => "Excessive string concatenation: $concat_count times",
                'note' => 'Often used to obfuscate function names',
            );
        }
        
        // 3. è®Šè®Šæ•¸ (Variable Variables: $$var)
        if ( preg_match('/\$\$\w+/i', $content ) ) {
            $indicators['variable_variables'] = array(
                'severity' => 'MEDIUM',
                'description' => 'Use of variable variables ($$var)',
                'note' => 'Can be used to hide function calls',
            );
        }
        
        // 4. Hex ç·¨ç¢¼å­—ä¸² (è¶…é 5 å€‹)
        $hex_count = preg_match_all('/\\\\x[0-9a-f]{2}/i', $content );
        if ( $hex_count > 5 ) {
            $indicators['hex_encoding'] = array(
                'severity' => 'HIGH',
                'description' => "Hex-encoded strings detected: $hex_count",
                'example' => '\x65\x76\x61\x6c = eval',
            );
        }
        
        // 5. Chr/Ord æ¿«ç”¨ (è¶…é 5 æ¬¡)
        $chr_count = preg_match_all('/chr\s*\(\s*\d+\s*\)/i', $content );
        if ( $chr_count > 5 ) {
            $indicators['chr_abuse'] = array(
                'severity' => 'MEDIUM',
                'description' => "Excessive use of chr(): $chr_count times",
                'note' => 'chr(101).chr(118).chr(97).chr(108) = eval',
            );
        }
        
        // 6. GLOBALS æ¿«ç”¨ (è¶…é 3 æ¬¡)
        $globals_count = preg_match_all('/\$GLOBALS\[/i', $content );
        if ( $globals_count > 3 ) {
            $indicators['globals_abuse'] = array(
                'severity' => 'MEDIUM',
                'description' => "Excessive use of \$GLOBALS: $globals_count times",
            );
        }
        
        // 7. è¨»é‡‹æ··æ·† (åœ¨å‡½æ•¸åä¸­æ’å…¥è¨»é‡‹)
        if ( preg_match('/(eval|system|assert)\/\*.*?\*\//i', $content ) ) {
            $indicators['comment_obfuscation'] = array(
                'severity' => 'HIGH',
                'description' => 'Function names split by comments',
                'example' => 'ev/*comment*/al($code)',
            );
        }
        
        return $indicators;
    }
}
```

#### 2.3 WordPress ç‰¹å®šæ¼æ´æŒ‡ç´‹

```php
/**
 * æª¢æ¸¬å·²çŸ¥çš„ WordPress æ’ä»¶/ä¸»é¡Œæ¼æ´
 */
private function get_wordpress_vulnerability_signatures() {
    return array(
        // TimThumb é ç¨‹æ–‡ä»¶åŒ…å«
        array(
            'name' => 'timthumb_rfi',
            'file_pattern' => 'timthumb\.php$',
            'content_pattern' => '/webshot\.php|src=.*?https?:\/\//i',
            'cve' => 'CVE-2011-4106',
            'severity' => 'CRITICAL',
            'description' => 'TimThumb Remote File Inclusion vulnerability',
        ),
        
        // Revolution Slider ä»»æ„æ–‡ä»¶ä¸‹è¼‰
        array(
            'name' => 'revslider_file_download',
            'file_pattern' => 'revslider',
            'content_pattern' => '/force-download|download-file/i',
            'cve' => 'CVE-2015-1579',
            'severity' => 'HIGH',
            'description' => 'Revolution Slider arbitrary file download',
        ),
        
        // MailPoet æœªæˆæ¬Šä¸Šå‚³
        array(
            'name' => 'mailpoet_upload',
            'file_pattern' => 'mailpoet',
            'content_pattern' => '/wysija_upload/i',
            'cve' => 'CVE-2014-8326',
            'severity' => 'CRITICAL',
            'description' => 'MailPoet unauthorized file upload',
        ),
        
        // WP-VCD æƒ¡æ„è»Ÿé«” (functions.php æ³¨å…¥)
        array(
            'name' => 'wp_vcd_malware',
            'file_pattern' => 'functions\.php$',
            'content_pattern' => '/wp-vcd\.php|wp-tmp\.php/i',
            'severity' => 'CRITICAL',
            'description' => 'WP-VCD malware infection in theme',
        ),
    );
}
```

---

### Layer 3: å•Ÿç™¼å¼åˆ†æ (Heuristic Analysis)

**ç›®æ¨™**: æª¢æ¸¬æœªçŸ¥çš„å¨è„…,åŸºæ–¼è¡Œç‚ºå’Œç•°å¸¸æ¨¡å¼

#### 3.1 ç•°å¸¸ä½ç½®æª¢æ¸¬

```php
class WPSA_Location_Analyzer {
    
    /**
     * æª¢æŸ¥æ–‡ä»¶ä½ç½®æ˜¯å¦å¯ç–‘
     */
    public function check_suspicious_location( $file_path ) {
        $threats = array();
        
        // è¦å‰‡ 1: Uploads ç›®éŒ„ä¸æ‡‰æœ‰ PHP æ–‡ä»¶
        if ( $this->is_in_uploads( $file_path ) && $this->is_php_file( $file_path ) ) {
            $threats[] = array(
                'type' => 'PHP_IN_UPLOADS',
                'severity' => 'HIGH',
                'description' => 'PHP file found in uploads directory',
                'reason' => 'Uploads should only contain media files',
                'recommendation' => 'Delete this file unless you explicitly uploaded it',
            );
        }
        
        // è¦å‰‡ 2: å¯ç–‘çš„æ–‡ä»¶åæ¨¡å¼
        $suspicious_filenames = array(
            '/^(config|setup|install|mysql|db|backup|dump|shell|cmd|admin|login|test)\.php$/i',
            '/^(c99|r57|wso|b374k|idx|sym|bypass)\.php$/i', // å·²çŸ¥ webshell åç¨±
            '/^[a-f0-9]{32}\.php$/i', // MD5 é›œæ¹Šå‘½å
            '/^\d{10,}\.php$/i', // Unix timestamp å‘½å
        );
        
        $filename = basename( $file_path );
        
        foreach ( $suspicious_filenames as $pattern ) {
            if ( preg_match( $pattern, $filename ) ) {
                $threats[] = array(
                    'type' => 'SUSPICIOUS_FILENAME',
                    'severity' => 'MEDIUM',
                    'description' => "Suspicious filename pattern: $filename",
                );
            }
        }
        
        // è¦å‰‡ 3: éš±è—æ–‡ä»¶ (ä»¥ . é–‹é ­)
        if ( preg_match('/^\.[\w-]+\.php$/i', $filename ) ) {
            $threats[] = array(
                'type' => 'HIDDEN_PHP_FILE',
                'severity' => 'MEDIUM',
                'description' => 'Hidden PHP file (starts with dot)',
            );
        }
        
        // è¦å‰‡ 4: æ ¸å¿ƒç›®éŒ„ä¸­çš„éæ ¸å¿ƒæ–‡ä»¶
        if ( $this->is_in_core_directory( $file_path ) && ! $this->is_core_file( $file_path ) ) {
            $threats[] = array(
                'type' => 'UNKNOWN_FILE_IN_CORE',
                'severity' => 'HIGH',
                'description' => 'Unknown file in WordPress core directory',
            );
        }
        
        return $threats;
    }
    
    private function is_in_uploads( $file_path ) {
        $upload_dir = wp_upload_dir();
        return strpos( $file_path, $upload_dir['basedir'] ) === 0;
    }
    
    private function is_in_core_directory( $file_path ) {
        $core_dirs = array( 'wp-admin', 'wp-includes' );
        
        foreach ( $core_dirs as $dir ) {
            if ( strpos( $file_path, ABSPATH . $dir ) === 0 ) {
                return true;
            }
        }
        
        return false;
    }
}
```

#### 3.2 æ™‚é–“æˆ³è¨˜ç•°å¸¸æª¢æ¸¬

```php
class WPSA_Timestamp_Analyzer {
    
    /**
     * æª¢æ¸¬æ–‡ä»¶æ™‚é–“æˆ³è¨˜ç•°å¸¸
     */
    public function detect_timestamp_anomaly( $file_path ) {
        $modified_time = filemtime( $file_path );
        $current_time = time();
        $anomalies = array();
        
        // ç•°å¸¸ 1: æ ¸å¿ƒæ–‡ä»¶åœ¨æœ€è¿‘ 24 å°æ™‚å…§è¢«ä¿®æ”¹
        if ( $this->is_core_file( $file_path ) ) {
            $age_hours = ( $current_time - $modified_time ) / HOUR_IN_SECONDS;
            
            if ( $age_hours < 24 ) {
                $anomalies[] = array(
                    'type' => 'RECENTLY_MODIFIED_CORE',
                    'severity' => 'HIGH',
                    'description' => sprintf(
                        'Core file modified %d hours ago',
                        round( $age_hours )
                    ),
                    'modified_time' => date( 'Y-m-d H:i:s', $modified_time ),
                );
            }
        }
        
        // ç•°å¸¸ 2: æœªä¾†æ™‚é–“æˆ³è¨˜ (ä¼ºæœå™¨æ™‚é–“è¢«ç«„æ”¹?)
        if ( $modified_time > $current_time + HOUR_IN_SECONDS ) {
            $anomalies[] = array(
                'type' => 'FUTURE_TIMESTAMP',
                'severity' => 'MEDIUM',
                'description' => 'File has future modification time',
                'modified_time' => date( 'Y-m-d H:i:s', $modified_time ),
            );
        }
        
        // ç•°å¸¸ 3: åŒç›®éŒ„ä¸‹å”¯ä¸€çš„æ–°æ–‡ä»¶ (å­¤ç«‹æ³¨å…¥)
        $dir_files = glob( dirname( $file_path ) . '/*.php' );
        $recent_threshold = $current_time - ( 7 * DAY_IN_SECONDS ); // ä¸€é€±å…§
        
        $recent_files = array_filter( $dir_files, function( $f ) use ( $recent_threshold ) {
            return filemtime( $f ) > $recent_threshold;
        });
        
        if ( count( $recent_files ) === 1 && in_array( $file_path, $recent_files ) ) {
            $anomalies[] = array(
                'type' => 'LONE_RECENT_FILE',
                'severity' => 'MEDIUM',
                'description' => 'Only recently modified file in directory',
                'note' => 'Could indicate isolated injection',
            );
        }
        
        return $anomalies;
    }
}
```

#### 3.3 ä»£ç¢¼è¡Œç‚ºåˆ†æ

```php
class WPSA_Behavior_Analyzer {
    
    /**
     * åˆ†æä»£ç¢¼çš„å¯ç–‘è¡Œç‚º
     */
    public function analyze_code_behavior( $content, $file_path ) {
        $behaviors = array();
        
        // è¡Œç‚º 1: ç¶²è·¯é€šè¨Šèƒ½åŠ› (C&C é€£æ¥)
        if ( $this->has_network_capability( $content ) ) {
            $behaviors[] = array(
                'type' => 'NETWORK_COMMUNICATION',
                'severity' => 'MEDIUM',
                'description' => 'Code makes external HTTP requests',
                'indicators' => $this->extract_urls( $content ),
            );
        }
        
        // è¡Œç‚º 2: æ–‡ä»¶å¯«å…¥èƒ½åŠ› (æŒä¹…åŒ–)
        if ( $this->has_file_write_capability( $content ) ) {
            $behaviors[] = array(
                'type' => 'FILE_WRITING',
                'severity' => 'LOW',
                'description' => 'Code can write to files',
            );
        }
        
        // è¡Œç‚º 3: ç¹é wpdb ç›´æ¥æ“ä½œè³‡æ–™åº«
        if ( $this->has_direct_db_access( $content ) ) {
            $behaviors[] = array(
                'type' => 'DIRECT_DB_ACCESS',
                'severity' => 'MEDIUM',
                'description' => 'Direct MySQL access (bypassing $wpdb)',
                'note' => 'May indicate database backdoor',
            );
        }
        
        // è¡Œç‚º 4: Email ç™¼é€ + ç”¨æˆ¶è¼¸å…¥ (spam backdoor)
        if ( $this->can_send_email_with_user_input( $content ) ) {
            $behaviors[] = array(
                'type' => 'EMAIL_SENDING',
                'severity' => 'HIGH',
                'description' => 'Can send emails with user-controlled content',
                'note' => 'Common spam backdoor technique',
            );
        }
        
        // è¡Œç‚º 5: éåº¦ä½¿ç”¨éŒ¯èª¤æŠ‘åˆ¶ (@)
        $suppression_count = preg_match_all('/@(file_|fopen|include|require|eval|system)/i', $content );
        
        if ( $suppression_count > 3 ) {
            $behaviors[] = array(
                'type' => 'ERROR_SUPPRESSION',
                'severity' => 'MEDIUM',
                'description' => "Excessive error suppression: $suppression_count instances",
                'note' => 'Used to hide malicious activity from logs',
            );
        }
        
        return $behaviors;
    }
    
    private function has_network_capability( $content ) {
        return preg_match('/(file_get_contents|curl_exec|fsockopen|stream_socket_client)\s*\(\s*[\'"]https?:\/\//i', $content );
    }
    
    private function extract_urls( $content ) {
        preg_match_all('/https?:\/\/[^\s\'"]+/i', $content, $matches );
        return array_unique( $matches[0] );
    }
    
    private function can_send_email_with_user_input( $content ) {
        $has_mail = preg_match('/(mail|wp_mail)\s*\(/i', $content );
        $has_input = preg_match('/\$_(GET|POST|REQUEST|COOKIE)/i', $content );
        
        return $has_mail && $has_input;
    }
}
```

---

## 3. æª”æ¡ˆæ“ä½œå®‰å…¨ (File Safety)

### éš”é›¢æ©Ÿåˆ¶ (Quarantine System)

**çµ•å°ç¦æ­¢ç›´æ¥åˆªé™¤**: åˆªé™¤æ–‡ä»¶å¯èƒ½å°è‡´ç¶²ç«™å´©æ½°æˆ–èª¤åˆªæ­£å¸¸æ–‡ä»¶ã€‚

```php
class WPSA_Quarantine_Manager {
    
    const QUARANTINE_DIR = WP_CONTENT_DIR . '/uploads/wpsa-quarantine/';
    
    /**
     * åˆå§‹åŒ–éš”é›¢å€
     */
    public function init_quarantine() {
        // å‰µå»ºéš”é›¢ç›®éŒ„
        if ( ! file_exists( self::QUARANTINE_DIR ) ) {
            wp_mkdir_p( self::QUARANTINE_DIR );
        }
        
        // å‰µå»º .htaccess é˜»æ­¢åŸ·è¡Œ
        $htaccess_content = "# WPSA Quarantine - Deny all access\n";
        $htaccess_content .= "Order deny,allow\n";
        $htaccess_content .= "Deny from all\n";
        
        file_put_contents( 
            self::QUARANTINE_DIR . '.htaccess', 
            $htaccess_content 
        );
        
        // å‰µå»º index.php é˜²æ­¢ç›®éŒ„ç€è¦½
        file_put_contents( 
            self::QUARANTINE_DIR . 'index.php', 
            '<?php // Silence is golden' 
        );
    }
    
    /**
     * éš”é›¢å¯ç–‘æ–‡ä»¶
     */
    public function quarantine_file( $file_path, $threat_info ) {
        // ç”Ÿæˆå”¯ä¸€çš„éš”é›¢æ–‡ä»¶å
        $timestamp = date( 'Y-m-d_His' );
        $hash = substr( md5( $file_path ), 0, 8 );
        $original_name = basename( $file_path );
        
        $quarantine_name = sprintf(
            '%s_%s_%s.suspected',
            $timestamp,
            $hash,
            $original_name
        );
        
        $quarantine_path = self::QUARANTINE_DIR . $quarantine_name;
        
        // ç§»å‹•æ–‡ä»¶åˆ°éš”é›¢å€
        $moved = rename( $file_path, $quarantine_path );
        
        if ( ! $moved ) {
            // å¦‚æœç„¡æ³•ç§»å‹•,å˜—è©¦è¤‡è£½ç„¶å¾Œåˆªé™¤
            if ( copy( $file_path, $quarantine_path ) ) {
                unlink( $file_path );
                $moved = true;
            }
        }
        
        if ( $moved ) {
            // è¨˜éŒ„éš”é›¢ä¿¡æ¯
            $this->log_quarantine( $file_path, $quarantine_path, $threat_info );
            
            return array(
                'success' => true,
                'quarantine_path' => $quarantine_path,
                'message' => 'File successfully quarantined',
            );
        }
        
        return array(
            'success' => false,
            'error' => 'Failed to quarantine file',
        );
    }
    
    /**
     * è¨˜éŒ„éš”é›¢æ“ä½œ
     */
    private function log_quarantine( $original_path, $quarantine_path, $threat_info ) {
        $log_entry = array(
            'timestamp' => current_time( 'mysql' ),
            'original_path' => $original_path,
            'quarantine_path' => $quarantine_path,
            'threat_type' => $threat_info['type'],
            'severity' => $threat_info['severity'],
            'description' => $threat_info['description'],
        );
        
        $quarantine_log = get_option( 'wpsa_quarantine_log', array() );
        $quarantine_log[] = $log_entry;
        
        update_option( 'wpsa_quarantine_log', $quarantine_log );
    }
    
    /**
     * æ¢å¾©éš”é›¢æ–‡ä»¶ (ç®¡ç†å“¡æ‰‹å‹•æ“ä½œ)
     */
    public function restore_file( $quarantine_path, $original_path ) {
        if ( ! current_user_can( 'manage_options' ) ) {
            return array( 'success' => false, 'error' => 'Unauthorized' );
        }
        
        // ç¢ºèªæ–‡ä»¶å­˜åœ¨
        if ( ! file_exists( $quarantine_path ) ) {
            return array( 'success' => false, 'error' => 'File not found' );
        }
        
        // æ¢å¾©æ–‡ä»¶
        $restored = rename( $quarantine_path, $original_path );
        
        if ( $restored ) {
            // æ›´æ–°æ—¥èªŒ
            $this->log_restore( $quarantine_path, $original_path );
            
            return array(
                'success' => true,
                'message' => 'File restored successfully',
            );
        }
        
        return array( 'success' => false, 'error' => 'Failed to restore file' );
    }
}
```

---

## Complete Scanning Workflow (å®Œæ•´æƒæå·¥ä½œæµç¨‹)

### å®Œæ•´çš„æƒæç”Ÿå‘½å‘¨æœŸ

```php
class WPSA_Scanner_Orchestrator {
    
    /**
     * Phase 1: åˆå§‹åŒ–æƒæ
     */
    public function start_scan( $scan_options = array() ) {
        // 1. è¨­ç½® PHP ç’°å¢ƒ
        $this->configure_php_environment();
        
        // 2. å‰µå»ºæƒææœƒè©±
        $scan_id = $this->create_scan_session();
        
        // 3. å»ºç«‹æ–‡ä»¶ç´¢å¼•
        $file_index = $this->build_file_index( $scan_options );
        
        // 4. åˆå§‹åŒ–é€²åº¦è¿½è¹¤
        $this->init_progress_tracking( $scan_id, count( $file_index ) );
        
        // 5. è§¸ç™¼ç¬¬ä¸€æ‰¹æƒæ
        wp_schedule_single_event( time(), 'wpsa_scan_batch', array( $scan_id ) );
        
        return array(
            'scan_id' => $scan_id,
            'total_files' => count( $file_index ),
            'status' => 'initiated',
        );
    }
    
    /**
     * Phase 2: åˆ†æ‰¹æƒæåŸ·è¡Œ
     */
    public function execute_batch( $scan_id ) {
        $start_time = microtime( true );
        $progress = $this->get_progress( $scan_id );
        
        // ç²å–å¾…æƒææ–‡ä»¶
        $files = $this->get_next_batch( $progress );
        
        foreach ( $files as $file ) {
            // æ™‚é–“æª¢æŸ¥
            if ( $this->should_stop_batch( $start_time ) ) {
                $this->schedule_next_batch( $scan_id );
                return;
            }
            
            // åŸ·è¡Œä¸‰å±¤æª¢æ¸¬
            $threats = $this->scan_file_complete( $file );
            
            // å¦‚æœç™¼ç¾å¨è„…,åŸ·è¡Œè™•ç†
            if ( ! empty( $threats ) ) {
                $this->handle_threats( $file, $threats );
            }
            
            // æ›´æ–°é€²åº¦
            $this->update_progress( $scan_id, $file );
            
            // è¨˜æ†¶é«”ç®¡ç†
            if ( $progress['scanned'] % 10 === 0 ) {
                gc_collect_cycles();
            }
        }
        
        // æª¢æŸ¥æ˜¯å¦å®Œæˆ
        if ( $this->is_scan_complete( $scan_id ) ) {
            $this->finalize_scan( $scan_id );
        } else {
            $this->schedule_next_batch( $scan_id );
        }
    }
    
    /**
     * åŸ·è¡Œå–®å€‹æ–‡ä»¶çš„å®Œæ•´ä¸‰å±¤æª¢æ¸¬
     */
    private function scan_file_complete( $file_path ) {
        $all_threats = array();
        
        // Layer 1: å¿«é€Ÿç¯©é¸
        $checksum_result = $this->verify_checksum( $file_path );
        
        if ( $checksum_result === 'VERIFIED_SAFE' ) {
            return array(); // æ–‡ä»¶å®‰å…¨,è·³é
        }
        
        if ( $checksum_result === 'MODIFIED_CORE' ) {
            $all_threats[] = array(
                'layer' => 1,
                'type' => 'MODIFIED_CORE_FILE',
                'severity' => 'CRITICAL',
            );
        }
        
        // è®€å–æ–‡ä»¶å…§å®¹ (ç”¨æ–¼å¾ŒçºŒæª¢æ¸¬)
        $content = $this->safe_file_read( $file_path );
        
        if ( $content === false ) {
            return array(); // ç„¡æ³•è®€å–,è·³é
        }
        
        // Layer 1: ç†µå€¼æª¢æ¸¬
        $entropy_result = $this->check_entropy( $content );
        
        if ( $entropy_result !== 'SAFE' ) {
            $all_threats[] = $entropy_result;
        }
        
        // Layer 2: ç‰¹å¾µç¢¼åŒ¹é…
        $signature_threats = $this->scan_signatures( $content );
        $all_threats = array_merge( $all_threats, $signature_threats );
        
        // Layer 2: æ··æ·†æª¢æ¸¬
        $obfuscation_threats = $this->detect_obfuscation( $content );
        $all_threats = array_merge( $all_threats, $obfuscation_threats );
        
        // Layer 3: ä½ç½®æª¢æ¸¬
        $location_threats = $this->check_location( $file_path );
        $all_threats = array_merge( $all_threats, $location_threats );
        
        // Layer 3: æ™‚é–“æˆ³è¨˜æª¢æ¸¬
        $timestamp_threats = $this->check_timestamp( $file_path );
        $all_threats = array_merge( $all_threats, $timestamp_threats );
        
        // Layer 3: è¡Œç‚ºåˆ†æ
        $behavior_threats = $this->analyze_behavior( $content, $file_path );
        $all_threats = array_merge( $all_threats, $behavior_threats );
        
        return $all_threats;
    }
    
    /**
     * Phase 3: ç”Ÿæˆæƒæå ±å‘Š
     */
    public function generate_report( $scan_id ) {
        $progress = $this->get_progress( $scan_id );
        $threats = $this->get_all_threats( $scan_id );
        
        // å¨è„…åˆ†é¡
        $categorized = $this->categorize_threats( $threats );
        
        $report = array(
            'scan_id' => $scan_id,
            'timestamp' => current_time( 'mysql' ),
            'summary' => array(
                'total_files' => $progress['total'],
                'scanned_files' => $progress['scanned'],
                'threats_found' => count( $threats ),
                'critical' => $categorized['CRITICAL'],
                'high' => $categorized['HIGH'],
                'medium' => $categorized['MEDIUM'],
                'low' => $categorized['LOW'],
                'scan_duration' => $progress['end_time'] - $progress['start_time'],
            ),
            'threats' => $threats,
            'recommendations' => $this->generate_recommendations( $threats ),
        );
        
        return $report;
    }
}
```

---

## Error Handling & Fault Tolerance (éŒ¯èª¤è™•ç†)

```php
class WPSA_Error_Handler {
    
    /**
     * å®‰å…¨çš„æ–‡ä»¶è®€å–
     */
    public function safe_file_read( $file_path ) {
        try {
            // æª¢æŸ¥ 1: æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if ( ! file_exists( $file_path ) ) {
                $this->log_error( 'FILE_NOT_FOUND', $file_path );
                return false;
            }
            
            // æª¢æŸ¥ 2: æ˜¯å¦å¯è®€
            if ( ! is_readable( $file_path ) ) {
                $this->log_error( 'FILE_NOT_READABLE', $file_path );
                return false;
            }
            
            // æª¢æŸ¥ 3: æ–‡ä»¶å¤§å°é™åˆ¶
            $max_size = 5 * MB_IN_BYTES; // 5MB
            $file_size = filesize( $file_path );
            
            if ( $file_size > $max_size ) {
                $this->log_warning( 'FILE_TOO_LARGE', $file_path, $file_size );
                
                // åˆ†å¡Šè®€å–å¤§æ–‡ä»¶
                return $this->read_file_in_chunks( $file_path );
            }
            
            // è®€å–æ–‡ä»¶
            $content = @file_get_contents( $file_path );
            
            if ( $content === false ) {
                $this->log_error( 'FILE_READ_FAILED', $file_path );
                return false;
            }
            
            return $content;
            
        } catch ( Exception $e ) {
            $this->log_exception( 'FILE_READ_EXCEPTION', $file_path, $e );
            return false;
        }
    }
    
    /**
     * åˆ†å¡Šè®€å–å¤§æ–‡ä»¶
     */
    private function read_file_in_chunks( $file_path ) {
        $handle = @fopen( $file_path, 'r' );
        
        if ( ! $handle ) {
            return false;
        }
        
        $content = '';
        $chunk_size = 1024 * 1024; // 1MB chunks
        
        while ( ! feof( $handle ) ) {
            $content .= fread( $handle, $chunk_size );
        }
        
        fclose( $handle );
        
        return $content;
    }
    
    /**
     * è¨˜éŒ„éŒ¯èª¤
     */
    private function log_error( $error_type, $file_path, $extra = null ) {
        $log_entry = array(
            'timestamp' => current_time( 'mysql' ),
            'type' => 'ERROR',
            'code' => $error_type,
            'file' => $file_path,
            'extra' => $extra,
        );
        
        $error_log = get_option( 'wpsa_error_log', array() );
        $error_log[] = $log_entry;
        
        // åªä¿ç•™æœ€è¿‘ 100 æ¢éŒ¯èª¤
        if ( count( $error_log ) > 100 ) {
            $error_log = array_slice( $error_log, -100 );
        }
        
        update_option( 'wpsa_error_log', $error_log );
    }
}
```

---

# Response Format (å ±å‘Šæ ¼å¼)

## æƒæå ±å‘Šçµæ§‹

```markdown
# ğŸ”’ WordPress æƒ¡æ„è»Ÿé«”æƒæå ±å‘Š

## ğŸ“Š æƒæç¸½çµ
- **æƒæ ID**: {scan_id}
- **æƒææ™‚é–“**: {timestamp}
- **ç¸½æ–‡ä»¶æ•¸**: {total_files}
- **å·²æƒæ**: {scanned_files}
- **ç™¼ç¾å¨è„…**: {threats_found}
- **æƒæè€—æ™‚**: {duration} ç§’

## ğŸš¨ å¨è„…ç­‰ç´šåˆ†å¸ƒ
- ğŸ”´ **Critical**: {critical_count} å€‹
- ğŸŸ  **High**: {high_count} å€‹
- ğŸŸ¡ **Medium**: {medium_count} å€‹
- ğŸŸ¢ **Low**: {low_count} å€‹

## âš ï¸ æª¢æ¸¬åˆ°çš„å¨è„…

### [#1] Eval + Base64 Backdoor - Critical ğŸ”´

**æ–‡ä»¶ä½ç½®**: `wp-content/themes/mytheme/footer.php`  
**å¨è„…é¡å‹**: MALWARE_SIGNATURE (eval_base64)  
**åš´é‡æ€§**: Critical  
**æª¢æ¸¬å±¤ç´š**: Layer 2 (Signature Matching)

**å•é¡Œä»£ç¢¼** (Line 45):
```php
<?php
// ... æ­£å¸¸ä»£ç¢¼ ...

eval(base64_decode('ZXZhbCgkX1BPU1RbJ2NtZCddKTs=')); // â† æƒ¡æ„ä»£ç¢¼

// ... æ­£å¸¸ä»£ç¢¼ ...
?>
```

**Base64 è§£ç¢¼å¾Œ**:
```php
eval($_POST['cmd']);
```

**å¨è„…èªªæ˜**:
é€™æ˜¯ä¸€å€‹å…¸å‹çš„ PHP å¾Œé–€,å…è¨±æ”»æ“Šè€…é€šé POST è«‹æ±‚åŸ·è¡Œä»»æ„ PHP ä»£ç¢¼ã€‚æ”»æ“Šè€…å¯ä»¥:
- è®€å–/ä¿®æ”¹/åˆªé™¤ä»»ä½•æ–‡ä»¶
- è¨ªå•æ•¸æ“šåº«
- ä¸Šå‚³æ›´å¤šæƒ¡æ„ä»£ç¢¼
- å®Œå…¨æ§åˆ¶ç¶²ç«™

**å»ºè­°æ“ä½œ**:
1. âœ… **ç«‹å³éš”é›¢**: æ–‡ä»¶å·²è‡ªå‹•ç§»å‹•åˆ°éš”é›¢å€
2. ğŸ” **æª¢æŸ¥å½±éŸ¿**: æŸ¥çœ‹æ­¤æ–‡ä»¶çš„æœ€å¾Œä¿®æ”¹æ™‚é–“,ç¢ºèªè¢«å…¥ä¾µçš„æ™‚é–“ç¯„åœ
3. ğŸ”‘ **æ›´æ”¹å¯†ç¢¼**: é‡ç½®æ‰€æœ‰ç®¡ç†å“¡å¯†ç¢¼å’Œ FTP/SSH æ†‘è­‰
4. ğŸ›¡ï¸ **ä¿®è£œæ¼æ´**: ç¢ºèªæ”»æ“Šè€…å¦‚ä½•ä¸Šå‚³æ­¤æ–‡ä»¶,ä¿®è£œç›¸é—œæ¼æ´

---

### [#2] PHP in Uploads Directory - High ğŸŸ 

**æ–‡ä»¶ä½ç½®**: `wp-content/uploads/2024/03/shell.php`  
**å¨è„…é¡å‹**: PHP_IN_UPLOADS  
**åš´é‡æ€§**: High  
**æª¢æ¸¬å±¤ç´š**: Layer 3 (Location Analysis)

**å¨è„…èªªæ˜**:
Uploads ç›®éŒ„é€šå¸¸åªæ‡‰åŒ…å«åª’é«”æ–‡ä»¶ (åœ–ç‰‡ã€PDF ç­‰),ä¸æ‡‰æœ‰å¯åŸ·è¡Œçš„ PHP æ–‡ä»¶ã€‚

**å»ºè­°æ“ä½œ**:
1. âœ… **å·²éš”é›¢**
2. ğŸ” **æª¢æŸ¥ä¸Šå‚³æ¼æ´**: ç¢ºèªæ˜¯å¦æœ‰æ’ä»¶å…è¨±æœªç¶“é©—è­‰çš„æ–‡ä»¶ä¸Šå‚³

---

## ğŸ“‹ å»ºè­°å¾ŒçºŒè¡Œå‹•

### ğŸ”´ ç·Šæ€¥è¡Œå‹• (Critical)
1. ç«‹å³éš”é›¢æ‰€æœ‰ Critical ç´šåˆ¥çš„æ–‡ä»¶
2. æ›´æ”¹æ‰€æœ‰å¯†ç¢¼ (WordPress, FTP, SSH, è³‡æ–™åº«)
3. å¯©æŸ¥ç®¡ç†å“¡å¸³æˆ¶,åˆªé™¤å¯ç–‘å¸³æˆ¶
4. æª¢æŸ¥è¿‘æœŸçš„æ–‡ä»¶ä¿®æ”¹è¨˜éŒ„

### ğŸŸ  é‡è¦è¡Œå‹• (High)
1. å¯©æŸ¥æ‰€æœ‰ High ç´šåˆ¥å¨è„…
2. æ›´æ–°æ‰€æœ‰æ’ä»¶å’Œä¸»é¡Œåˆ°æœ€æ–°ç‰ˆæœ¬
3. å®‰è£ WordPress é˜²ç«ç‰† (å¦‚ Wordfence, Sucuri)

### ğŸŸ¡ æ”¹é€²è¡Œå‹• (Medium/Low)
1. å®šæœŸé€²è¡Œå®‰å…¨æƒæ
2. å•Ÿç”¨é›™å› ç´ èªè­‰
3. é™åˆ¶æ–‡ä»¶ä¸Šå‚³é¡å‹
4. è¨­ç½®æ–‡ä»¶æ¬Šé™ç‚º 644 (æ–‡ä»¶) å’Œ 755 (ç›®éŒ„)

## ğŸ”§ ç³»çµ±å¥åº·æª¢æŸ¥

- âœ… WordPress æ ¸å¿ƒæ–‡ä»¶å®Œæ•´æ€§: 98% é€šé
- âŒ ç™¼ç¾ 2 å€‹è¢«ä¿®æ”¹çš„æ ¸å¿ƒæ–‡ä»¶
- âœ… æ’ä»¶/ä¸»é¡Œ: 15 å€‹å·²æƒæ,2 å€‹ç™¼ç¾å¨è„…
- âš ï¸ æ–‡ä»¶æ¬Šé™: 3 å€‹æ–‡ä»¶å¯è¢«å…¶ä»–ç”¨æˆ¶å¯«å…¥

## ğŸ“ éœ€è¦å¹«åŠ©?

å¦‚æœæ‚¨éœ€è¦å°ˆæ¥­çš„ç¶²ç«™æ¸…ç†æœå‹™,è«‹è¯ç¹«:
- WordPress å®‰å…¨åœ˜éšŠ
- å°ˆæ¥­çš„ç¶²ç«™å®‰å…¨å…¬å¸ (Sucuri, Wordfence, SiteLock)
```

---

# Best Practices & Recommendations

## é–‹ç™¼æŒ‡å—

1. **æ°¸é ä½¿ç”¨åˆ†æ‰¹è™•ç†**: å³ä½¿åªæœ‰ 100 å€‹æ–‡ä»¶,ä¹Ÿè¦åˆ†æ‰¹
2. **æ™‚é–“é™åˆ¶**: æ¯æ‰¹æ¬¡ä¸è¶…é 3 ç§’
3. **è¨˜æ†¶é«”ç›£æ§**: ä½¿ç”¨ `memory_get_usage()` ç›£æ§
4. **éŒ¯èª¤å®¹å¿**: å–®å€‹æ–‡ä»¶å¤±æ•—ä¸æ‡‰å½±éŸ¿æ•´é«”æƒæ
5. **é€²åº¦å¯è¦–åŒ–**: æä¾›å¯¦æ™‚é€²åº¦æ¢çµ¦ç”¨æˆ¶
6. **å¯ä¸­æ–·æ¢å¾©**: ç”¨æˆ¶é—œé–‰é é¢å¾Œèƒ½è‡ªå‹•ç¹¼çºŒ

## æ€§èƒ½å„ªåŒ–

```php
// ä½¿ç”¨ OpCache (å¦‚æœå¯ç”¨)
if ( function_exists( 'opcache_compile_file' ) ) {
    opcache_compile_file( $file_path );
}

// å®šæœŸæ¸…ç†å…§å­˜
if ( $count % 10 === 0 ) {
    gc_collect_cycles();
}

// ä½¿ç”¨ç”Ÿæˆå™¨ç¯€çœè¨˜æ†¶é«”
function get_files_generator( $directory ) {
    $iterator = new RecursiveIteratorIterator(
        new RecursiveDirectoryIterator( $directory )
    );
    
    foreach ( $iterator as $file ) {
        yield $file;
    }
}
```

## å®‰å…¨å»ºè­°

1. **éš”é›¢è€Œéåˆªé™¤**: çµ¦ç”¨æˆ¶æ¢å¾©çš„æ©Ÿæœƒ
2. **æ¬Šé™æª¢æŸ¥**: åªæœ‰ç®¡ç†å“¡èƒ½åŸ·è¡Œæƒæ
3. **Nonce é©—è­‰**: æ‰€æœ‰ AJAX è«‹æ±‚éƒ½è¦é©—è­‰
4. **æ—¥èªŒè¨˜éŒ„**: è¨˜éŒ„æ‰€æœ‰é‡è¦æ“ä½œ
5. **é€šçŸ¥æ©Ÿåˆ¶**: ç™¼ç¾ Critical å¨è„…æ™‚ç™¼é€éƒµä»¶

---

# Continuous Learning

ä½œç‚ºæƒ¡æ„è»Ÿé«”çµäºº,æ‡‰è©²æŒçºŒå­¸ç¿’:

## è³‡æºæ¨è–¦
- [php-malware-finder](https://github.com/nbs-system/php-malware-finder) - é–‹æºçš„æƒ¡æ„ä»£ç¢¼ç‰¹å¾µåº«
- [YARA Rules for Malware](https://github.com/Yara-Rules/rules) - æƒ¡æ„ä»£ç¢¼è¦å‰‡åº«
- [WordPress Security White Paper](https://wordpress.org/about/security/) - å®˜æ–¹å®‰å…¨æ–‡æª”
- [Wordfence Blog](https://www.wordfence.com/blog/) - æœ€æ–°çš„ WordPress å®‰å…¨å¨è„…
- [Sucuri Blog](https://blog.sucuri.net/) - ç¶²ç«™å®‰å…¨æ¡ˆä¾‹ç ”ç©¶

## å¯¦æˆ°æ¡ˆä¾‹
å®šæœŸç ”ç©¶çœŸå¯¦çš„å…¥ä¾µæ¡ˆä¾‹:
- æ”»æ“Šè€…å¦‚ä½•é€²å…¥ç³»çµ±?
- ä½¿ç”¨äº†ä»€éº¼æ··æ·†æŠ€è¡“?
- å¦‚ä½•æ”¹é€²æª¢æ¸¬è¦å‰‡?

---

**è¨˜ä½æ ¸å¿ƒåŸå‰‡**:
1. æ°¸ä¸ç‚¸ç«™ (Don't Break the Site)
2. ç¸±æ·±é˜²ç¦¦ (Defense in Depth)
3. æ•…éšœå®‰å…¨ (Fail-Safe)
